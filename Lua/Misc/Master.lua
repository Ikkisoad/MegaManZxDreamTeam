saber_recolors_enable = true
rainbow_dash_enable = true
autofill_energy_enable = true
select_charge_enabled = true
hx_infinite_airdash_enable = true

zx_addresses = {0x020F7A52, 0x020F7A7A, 0x021E40EA, 0x021E468A, 0x021E4BAA, 0x021E4FCA, 0x021E57EA, 0x021E600A, 0x021E66AA, 0x021E68CA, 0x021E6BCA, 0x021E6B6A, 0x021E720A, 0x021E78AA, 0x021E7DCA, 0x021E828A, 0x021E882A, 0x021E8DCA, 0x021E956A, 0x021E9C0A, 0x021EA3AA, 0x021EA9CA, 0x021EAF6A, 0x021EB50A, 0x021EB9CA, 0x021EBEEA, 0x021EC48A, 0x021ECA2A, 0x021ECF0A, 0x021ED52A, 0x021ED94A, 0x021EDBEA, 0x021EE00A, 0x021EE32A, 0x021EE74A, 0x021EEA6A, 0x021EEE8A, 0x021EF1AA, 0x021EF5CA, 0x021EF8EA, 0x021EFD0A, 0x021EFF2A, 0x021F02CA, 0x021F066A, 0x021F0B8A, 0x021F11AA, 0x021FA38A, 0x021F1A2A, 0x021F20CA}
zx_addresses_2 = {0x020F7A54, 0x020F7A74, 0x021E40EC, 0x021E468C, 0x021E4BAC, 0x021E4FCC, 0x021E57EC, 0x021E600C, 0x021E66AC, 0x021E68CC, 0x021E6BCC, 0x021E6B6C, 0x021E720C, 0x021E78AC, 0x021E7DCC, 0x021E828C, 0x021E882C, 0x021E8DCC, 0x021E956C, 0x021E9C0C, 0x021EA3AC, 0x021EA9CC, 0x021EAF6C, 0x021EB50C, 0x021EB9CC, 0x021EBEEC, 0x021EC48C, 0x021ECA2C, 0x021ECF0C, 0x021ED52C, 0x021ED94C, 0x021EDBEC, 0x021EE00C, 0x021EE32C, 0x021EE74C, 0x021EEA6C, 0x021EEE8C, 0x021EF1AC, 0x021EF5CC, 0x021EF8EC, 0x021EFD0C, 0x021EFF2C, 0x021F02CC, 0x021F066C, 0x021F0B8C, 0x021F11AC, 0x021FA38C, 0x021F1A2C, 0x021F20CC}

hx_addresses = {0x020F7A6A, 0x021DCE46, 0x021DD3E6, 0x021DDB06, 0x021DE1A6, 0x021DE946, 0x021DEF66, 0x021DF506, 0x021DFAA6, 0x021DFF66, 0x021E0386, 0x021E0926, 0x021E0EC6, 0x021E1366, 0x021E1986, 0x021E1DA6, 0x021E2146, 0x021E24E6, 0x021E2A06, 0x021E3026, 0x021E33E6, 0x021E37A6, 0x021E3DE6, 0x021E4586, 0x021E4CC6, 0x021E5226, 0x021E5466, 0x021E5DA6, 0x021E66E6, 0x021E6C46, 0x021E7166, 0x021E76A6, 0x021E7FE6, 0x021E8926, 0x021E8D46, 0x021E9466, 0x021E9B86, 0x021EA126, 0x021EA866,
0x020F7A4A, 0x0215FD1A, 0x021EBE3A, 0x021EC72A, 0x021ECB4A, 0x021ECF6A, 0x021ED38A}
hx_addresses_2 = {0x020F7A6C, 0x021DCE48, 0x021DD3E8, 0x021DDB08, 0x021DE1A8, 0x021DE948, 0x021DEF68, 0x021DF508, 0x021DFAA8, 0x021DFF68, 0x021E0388, 0x021E0928, 0x021E0EC8, 0x021E1368, 0x021E1988, 0x021E1DA8, 0x021E2148, 0x021E24E8, 0x021E2A08, 0x021E3028, 0x021E33E8, 0x021E37A8, 0x021E3DE8, 0x021E4588, 0x021E4CC8, 0x021E5228, 0x021E5468, 0x021E5DA8, 0x021E66E8, 0x021E6C48, 0x021E7168, 0x021E76A8, 0x021E7FE8, 0x021E8928, 0x021E8D48, 0x021E9468, 0x021E9B88, 0x021EA128, 0x021EA868,
0x020F7A4C, 0x0215FD1C, 0x021EBE3C, 0x021EC72C, 0x021ECB4C, 0x021ECF6C, 0x021ED38C}
hx_addresses_3 = {0x020F7A70, 0x021DCE4C, 0x021DD3EC, 0x021DDB0C, 0x021DE1AC, 0x021DE94C, 0x021DEF6C, 0x021DF50C, 0x021DFAAC, 0x021DFF6C, 0x021E038C, 0x021E092C, 0x021E0ECC, 0x021E136C, 0x021E198C, 0x021E1DAC, 0x021E214C, 0x021E24EC, 0x021E2A0C, 0x021E302C, 0x021E33EC, 0x021E37AC, 0x021E3DEC, 0x021E458C, 0x021E4CCC, 0x021E522C, 0x021E546C, 0x021E5DAC, 0x021E66EC, 0x021E6C4C, 0x021E716C, 0x021E76AC, 0x021E7FEC, 0x021E892C, 0x021E8D4C, 0x021E946C, 0x021E9B8C, 0x021EA12C, 0x021EA86C,
0x020F7A50, 0x0215FD28, 0x021EBE40, 0x021EC730, 0x021ECB50, 0x021ECF70, 0x021ED390}

lx_addresses = {0x021DC0B6, 0x021DC7D6, 0x021DCD76, 0x021DD356, 0x021DD6B6, 0x021E03D6, 0x021E0C76, 0x021E1516, 0x021E1AF6, 0x021E2316, 0x021E27D6, 0x021E2DB6, 0x021E36F6, 0x021E4036, 0x021E4876, 0x021E5236, 0x021E5C16, 0x021E6176,
0x020F7A6E, 0x021D9F56, 0x021DA816, 0x021DAF36, 0x021DB356, 0x021DB996, 0x021DDAD6, 0x021DE376, 0x021DEC16, 0x021DF2B6, 0x021DFBF6, 0x021DFFB6, 0x021E66B6}
lx_addresses_2 = {0x021DC0B8, 0x021DC7D8, 0x021DCD78, 0x021DD358, 0x021DD6B8, 0x021E03D8, 0x021E0C78, 0x021E1518, 0x021E1AF8, 0x021E2318, 0x021E27D8, 0x021E2DB8, 0x021E36F8, 0x021E4038, 0x021E4878, 0x021E5238, 0x021E5C18, 0x021E6178,
0x020F7A70, 0x021D9F58, 0x021DA818, 0x021DAF38, 0x021DB358, 0x021DB998, 0x021DDAD8, 0x021DE378, 0x021DEC18, 0x021DF2B8, 0x021DFBF8, 0x021DFFB8, 0x021E66B8}
lx_addresses_3 = {0x021DC0C4, 0x021DC7E4, 0x021DCD84, 0x021DD364, 0x021DD6C4, 0x021E03E4, 0x021E0C84, 0x021E1524, 0x021E1B04, 0x021E2324, 0x021E27E4, 0x021E2DC4, 0x021E3704, 0x021E4044, 0x021E4884, 0x021E5244, 0x021E5C24, 0x021E6184,
0x020F7A7C, 0x021D9F64, 0x021DA824, 0x021DAF44, 0x021DB364, 0x021DBA04, 0x021DDAE4, 0x021DE384, 0x021DEC24, 0x021DF2C4, 0x021DFC04, 0x021DFFC4, 0x021E66C4}

function saber_recolors (enabled)
	if enabled then
		if memory.readword(0x021E78AA) == 24453 then --ZX
			for i,x in ipairs(zx_addresses) do
				memory.writeword(x, 10047) --yellorange
			end
			for i,x in ipairs(zx_addresses_2) do
				memory.writeword(x, 1085) --red
			end
		end
		if memory.readword(0x021E3DE6) == 32735 then --HX
			for i,x in ipairs(hx_addresses) do
				memory.writeword(x, 31743) --verylight yellow
			end
			for i,x in ipairs(hx_addresses_2) do
				memory.writedword(x, 520037343) --yellow, orange
			end
			for i,x in ipairs(hx_addresses_3) do
				memory.writedword(x, 1705021) --red, darkred
			end
		end
		if memory.readword(0x021E36F6) == 30465 then --LX
			for i,x in ipairs(lx_addresses) do
				memory.writeword(x, 1085) --red
			end
			for i,x in ipairs(lx_addresses_2) do
				memory.writeword(x, 10047) --yellorange
			end
			for i,x in ipairs(lx_addresses_3) do
				memory.writedword(x, 18) --dark red
			end
		end
	end
end


dash_addresses = {0x020F79EA, 0x020F79EC, 0x020F79EE, 0x020F79F0, 0x020F79F2, 0x020F79F4, 0x020F79F6, 0x020F79F8, 0x020F79FA, 0x020F79FC, 0x020F79FE, 0x020F7A00, 0x020F7A02, 0x020F7A04, 0x020F7A06} --current dash
dash_count = 26
dash_color = 6175 --red 6 steps backwards toward magenta
dash_delta = -1024

function rainbow_dash (enabled)
	if enabled then
		--dash
		for i,x in ipairs(dash_addresses) do
			memory.writeword(x, dash_color)
		end
		
		dash_color = dash_color + dash_delta
		
		if dash_count < 31 then
			dash_count = dash_count + 1
		else
			dash_count = 1
			if dash_delta == 32 then
				dash_delta = -1
			elseif dash_delta == -1 then
				dash_delta = 1024
			elseif dash_delta == 1024 then
				dash_delta = -32
			elseif dash_delta == -32 then
				dash_delta = 1
			elseif dash_delta == 1 then
				dash_delta = -1024
			elseif dash_delta == -1024 then
				dash_delta = 32
			end
		end
	end
end


autofill_frame_count = 0
hxcap = 32
fxcap = 32
lxcap = 32
pxcap = 32

function autofill_energy (enabled)
	if enabled then
		--record WE cap for each model since we can only see equipped's cap
		if memory.readbyte(0x0214F874) == 3 then
			hxcap = memory.readbyte(0x0214FE75)*4;
		elseif memory.readbyte(0x0214F874) == 4 then
			fxcap = memory.readbyte(0x0214FE75)*4;
		elseif memory.readbyte(0x0214F874) == 5 then
			lxcap = memory.readbyte(0x0214FE75)*4;
		elseif memory.readbyte(0x0214F874) == 6 then
			pxcap = memory.readbyte(0x0214FE75)*4;
		end
		
		if memory.readbyte(0x0214F895) < 32 or memory.readbyte(0x0214F896) < 32 or memory.readbyte(0x0214F897) < 32 or memory.readbyte(0x0214F897) < 32 then --if any of HX, FX, LX, or PX has less than 32 (so count isnt always going)
			if autofill_frame_count < 180 then --number of frames til energy point
				autofill_frame_count = autofill_frame_count + 1
			else --if each model's WE less than assumed cap and not currently equipped, add WE point
				if memory.readbyte(0x0214F895) < hxcap then --HX
					memory.writebyte(0x0214F895, memory.readbyte(0x0214F895) + 1)
				end
				if memory.readbyte(0x0214F896) < fxcap then --FX
					memory.writebyte(0x0214F896, memory.readbyte(0x0214F896) + 1)
				end
				if memory.readbyte(0x0214F897) < lxcap then --LX
					memory.writebyte(0x0214F897, memory.readbyte(0x0214F897) + 1)
				end
				if memory.readbyte(0x0214F898) < pxcap then --PX
					memory.writebyte(0x0214F898, memory.readbyte(0x0214F898) + 1)
				end
				autofill_frame_count = 0
			end
		end
		
		--if equipped model's WE is higher than its cap, reduce to cap
		if memory.readbyte(0x0214FE71) > memory.readbyte(0x0214FE75)*4 then
			if memory.readbyte(0x0214F874) == 3 then --if HX
				memory.writebyte(0x0214F895, memory.readbyte(0x0214FE75)*4)
			end
			if memory.readbyte(0x0214F874) == 4 then --if FX
				memory.writebyte(0x0214F896, memory.readbyte(0x0214FE75)*4)
			end
			if memory.readbyte(0x0214F874) == 5 then --if LX
				memory.writebyte(0x0214F897, memory.readbyte(0x0214FE75)*4)
			end
			if memory.readbyte(0x0214F874) == 6 then --if PX
				memory.writebyte(0x0214F898, memory.readbyte(0x0214FE75)*4)
			end
		end
	end
end


state = 0
pressed = false
function select_charge (enabled)
	if enabled then
		if state > 0 then
			memory.writebyte(0x0214F838, 0)
			memory.writebyte(0x0214F839, 0)
		end
		
		if joypad.get(1).select and not pressed then
			if state < 120 then
				state = state * 2 + 40 -- 0 to 40, 40 to 120
			else
				state = 0
			end
			pressed = true
			print(state)
		elseif not joypad.get(1).select and pressed then
			pressed = false
		end
		
		if state > 0 then
			if joypad.get(1).Y then
				memory.writebyte(0x0214F838, state)
			end
			if joypad.get(1).R then
				memory.writebyte(0x0214F839, state)
			end
		end
	end
end

function hx_infinite_airdash (enabled)
	if enabled then
		if memory.readbyte(0x0214F82F) == 4 then
			memory.writebyte(0x0214F82F, 0)
		end
	end
end

-----------------------------------------------

while true do
	saber_recolors(saber_recolors_enable)
	rainbow_dash(rainbow_dash_enable)
	autofill_energy(autofill_energy_enable)
	select_charge(select_charge_enabled)
	hx_infinite_airdash(hx_infinite_airdash_enable)
	
	emu.frameadvance()
end
